
ラボ:'Microsoft 365 エージェント SDK を使用してカスタム エンジン エージェントを作成する'
---
<!--
Edit the metadata above to manage the list of exercises in the home page of the GitHub site that gets generated.
You can delete the module and edit index.md in the root of the repo to customize the display so that only the exercises are listed
To enable GitHub page publishing, edit the Page settings for the repo and publish from the main branch
-->

# カスタム エージェントを作成してテストする

この演習では、カスタム エージェントを作成するための基礎として機能する Azure OpenAI リソースを作成します。

この演習の所要時間は約**60** 分です。 <!-- update with estimated duration -->

**注:** 学習者はこれらのオプションがあるこのラボを完了できます
1) 学習者向けに提供されるラボ環境。
2) 注: 学習者は、他のすべての ALH のために自分の環境でこのラボを完了することが期待されています。

##  タスク 1:Azure OpenAI リソースを作成する 

まず、...

1. お使いの Edge ブラウザーで、**https://portal.azure.com** に移動します。
1. Azure portal にサインインします。
2. 画面の左上で、**[+ リソースの作成]** を選択します。
1. 検索ボックスに「**azure openai**」と入力し、Enter キーを押します。
1. **Azure OpenAI** という結果がオプションとして表示されるはずです。 このオプションの左下隅には、**[作成]** とラベルが付けられたボタンがあります。 **[作成]** >**Aure OpenAI**を押します。
1. **[Azure OpenAI の作成]** ページで、次のフィールドを設定します。

**注:** 自分の環境を使用する学習者の場合、学習者は **[サブスクリプション]**、**[価格レベル]**、**[リソース グループ]** フィールドの値を選択するときに、自分の裁量で判断する必要があります。 提供されたラボ環境を使用する学習者の場合は、以下の手順 a から d のフィールドの既定値を選択します。
   
   a. **[サブスクリプション]** このフィールドに入力するときは、独自の裁量で判断します。
   
   b. **[リソース グループ]** : このフィールドに入力するときは、独自の裁量で判断します。
   
   c. **[名前]** : 選択した名前を入力します。
   
   d. **[価格レベル]**: 既定値は**Standard S0** ですが、このフィールドに入力するときは独自の裁量で判断します。
   
[**次へ**] を選択します。

7. 次のページの [**ネットワーク**] タブで、**[インターネットを含むすべてのネットワーク がこのリソースにアクセスできる]** オプションを選択します。
[**次へ**] を選択します。
8. **[タグ]** タブの次のページで、[名前] フィールドと [値] フィールドは空白のままにしておきます。
[**次へ**] を選択します。
9. 次のページの **[確認と送信]** タブで、**[作成]** を押します。
10. この新しく作成された Azure OpenAI リソースが作成されているページに移動します。 "**デプロイを実行しています**" と表示されます。 このリソースのデプロイが完了するまで、数秒待ちます。 リソースがデプロイされたら、**[リソースに移動]** ボタンをクリックします
11. **結果:** 新しく作成された Azure OpenAI リソースが表示されたページにいます。 確認するには、ページの左上隅にあるリソースの名前を確認します。 この名前は、上記の手順 5c で選択した名前と一致している必要があります。


## タスク 2: Azure OpenAI モデルに RAG を実装する

このタスクでは、独自のテスト環境のデータ ソースを使用して RAG を実装する方法を学びます。

1. 新しく作成された Azure OpenAI リソースのページで、ページの上部にあるリボンの **[Go to Azure AI Foundry portal]** をクリックします。
2. 左側の **[プレイグラウンド]** で、**[チャット]** を選択します。 次に、**[チャット プレイグラウンド]** の **[セットアップ]** というセクションで **[+ 新しいデプロイの作成]** を選択します。
3. **[チャット完了モデルを選択する]** というタイトルのポップアップ ウィンドウで、下にスクロールし、オプション **[gpt-4]** >**[確認]** を選択します。
4. **[モデル gpt-4 をデプロイする]** ウィンドウで、すべてを既定の設定のままにして、**[デプロイ]** を選択します。
5. **チャット プレイグラウンド**ページで、画面の下部の近くにある **[データの追加]** を選択し、**[+ データ ソースの追加]** を選択します。
6. **[データ ソースの選択または追加]** ウィンドウで、**[データ ソースの選択]** のドロップダウンを選択し、**[ファイルのアップロード (プレビュー)]** を選択します。
7. **[データ ソース]** の次のページで、**[データ ソースの選択]** のドロップダウンが **[ファイルのアップロード (プレビュー)]** に設定されていることを確認します。

**注:** 自分の環境を使用する学習者の場合、ユーザーは以下の手順 a から c のフィールドに入力するときに、自分の裁量で判断する必要がある場合があります。 提供されたラボ環境を使用する学習者の場合は、以下の手順 a から b で説明されている既定値を使用します。 
  
   a. **[サブスクリプション]** フィールドで、既定値が選択されていることを確認します。
   
   b. **"Azure Blob Storage リソースの選択"** フィールドで、**[新しい Azure Blob Storage リソースの作成]** を選択し、「**ストレージ アカウントの作成**」というタイトルが付けられた新しいウィンドウの **[基本]** タブの下で、**[サブスクリプション]** と **"リソース グループ"** フィールドが既定値に設定されていることを確認します。この場合、**[リソース グループ]** のみに使用可能な値を選択します。 **[インスタンスの詳細]** で、**ストレージ アカウント名** を設定します。 他のフィールドはそのままにします。 **[確認と作成]** を選択します。 **[確認と作成]** タブで、**[作成]** ボタンを選択します。 Azure Blob Storage リソースのデプロイには少し時間がかかります。
   
   c. **チャット プレイグラウンド**のウィンドウに戻ります。 **"Azure Blob Storage リソースの選択"** フィールドの横にある更新ボタンを選択し、上記の手順 b で作成したリソースを選択します。 **[CORS をオンにする]** ボタンを選択します。
   
8. **[Azure AI 検索リソースの選択]** フィールドでは、**[新しい Azure AI 検索リソースの作成]** を選択します。  **[サブスクリプション]** フィールドと **[リソース グループ]** フィールドが選択した値に設定されていることを確認します。

   **注:** 自分の環境を使用する学習者の場合は、**[サブスクリプション]** フィールドおよび **[リソース グループ]** フィールドの値を選択するときに、自分の裁量で判断してください。

9. **[リソース グループ]** のドロップダウン値をクリックして、選択するオプションを選択します。 **サービス名**を入力し、他のすべてのフィールドが既定値に設定されていることを確認したら、**[確認と作成]** >**[作成]** を選択します。 Azure AI 検索リソースのデプロイには少し時間がかかります。
10. **チャット プレイグラウンド**のウィンドウに戻ります。 **[Azure Blob Storage リソースの選択]** フィールドの横にある更新ボタンを選択し、上記の手順 9 で作成したリソースを選択します。
11. **[インデックス名を入力]** >**[次へ]** フィールドに名前を入力します。 この名前をコピーして、アクセス可能な場所に貼り付けます。これは、今後のタスクで必要になります。
12. **[ファイルのアップロード]** セクションで、**[ファイルを参照する]** を選択します。エクスプローラーで、**[ドキュメント]** に移動します。次の 3 つのファイルをすべて選択します。**ContosoAI ChipEnhance Perks Program.docx**、**ContosoAI Insurance Plans.docx**、および**Overview of ContosoAI.docx**。 >**[開く ]** を選択します。これで、3 つのファイルがウィンドウの **[ファイルのアップロード]** ページに表示されているはずです。**[ファイルのアップロード]** >**[次へ]** を選択します。
13. **[データ管理]** セクションで、すべてを既定値のままにして、**[次へ]** を選択します。
14. **[データ接続]** で、**[API キー]** >**[次へ]** >**[保存して閉じる]** を選択します。
15. **[チャット プレイグラウンド]** ウィンドウで、ウィンドウの左上にあるリボンにある **[コードを表示]** を選択します。
16. **サンプル コード**ウィンドウで、最初のフィールドの右側にあるドロップダウンを選択して、**json** を選択し、**[キー認証]** タブに切り替えます。
    
    a. 今後のタスクで必要になる次の値をコピーして貼り付けます。**エンドポイント**、**API キー**、**Azure 検索リソース キー**。 このウィンドウを開いたままにして、今後のタスクのこれらの値を収集することもできます。

 ## タスク 3: テスト ツールと Teams でカスタム エージェントを作成してテストする

このタスクでは、カスタム エージェントを作成し、エージェントをテストします。

1. **Visual Studio Code** を開きます。
2. Visual Studio Code ウィンドウの右側で、**[拡張機能]** の上部のリボンから **[ビュー]** を選択し、**Microsoft 365 エージェント ツールキット**を検索して、**[更新]** >**[拡張機能の再起動]** の順に選択し、**[新しいエージェント/アプリの作成]** を選択し、ドロップダウンで **[カスタム エンジン エージェント]**  >**[ベーシック カスタム エンジン エージェント]** >**[JavaScript]** >**[Azure OpenAI]** を選択します。 **注** ツールキットを更新した後、VS コードを閉じてから再度開く必要がある場合があります。
3. 画面の上部にある空白のボックスに、最初に次のように入力します。

   a. 前のタスクから **[API キー]** を入力し、**[Enter]** を押します。

   b. 前のタスクから **[エンドポイント]** を入力し、**Enter** を押します。

   c. **[Azure Open AI デプロイ名]** には「**gpt-4**」と入力し、 >**Enter** を押して >**[JavaScript]** を選択します。 

   d. **プロジェクト ルーム フォルダーが配置されるフォルダーを選択します** については、**既定フォルダー** を選択します。

   e. **[入力アプリケーション名]** には任意の名前を入力します。ポップアップ ウィンドウで **[Enter]** を押し、**はい、作成者を信頼します**を選択します。

   f. 上記の手順 a から f で新しく作成したアプリの新しい VS Code ウィンドウで、画面の左側にある **[M365 ツールキット]** アイコンに移動します。

   **注:** Microsoft Teams 管理センターへの管理者アクセス権を持たないユーザー環境の場合、および／または提供されたラボ環境を使用する学習者環境の場合、手順 g から i を完了する必要があります。
  自分の環境を使用する学習者の場合は、代わりに手順 j から m を実行します。

   g. **[アカウント]** セクションで、**[Microsoft 365 にサインイン]** をクリックします。 ブラウザで新しいウィンドウが開きます。 指定された資格情報を使用してログインします。

   h. エージェントの VS Code ページに戻ります。 これで、[**アカウント] の下に **[カスタム アプリのアップロードが有効になっている]** という単語の緑色のチェック マークが表示されます。

   i. **[アカウント]** セクションで、**[Azure にサインイン]** をクリックします。 すべてのポップアップ ウィンドウで **[OK]** をクリックします。 ブラウザで新しいウィンドウが開きます。 指定された資格情報を使用してログインします。

   Microsoft Teams 管理センターへの管理者アクセス権のある M365 テナントを持っているユーザーの場合は、上記の手順 g から i ではなく、次の手順を実行してください。

   j. 管理者の資格情報でhttps://admin.teams.microsoft.com にサインインします。

   k. サイドバーで **Teams アプリ** に移動してから、 **[セットアップ ポリシー]** を選択します。

   l.  **[グローバル (組織全体の既定)]**  ポリシーを選択してから、 **[カスタム アプリのアップロード]**  切り替えをオンにします。

   m. 下にスクロールし、 **[保存]**  ボタンを選択して変更を保存します。 これで、テナントがカスタム アプリのサイドローディングを許可するようになりました。 

4. アプリの VS Code ウィンドウで、prompts/chat の下にある**src/config.js** ファイルに移動します。 **azureOpenAIKey:**、**azureOpenAIEnpoint:**、**azureOpenAIDeploymentName:** に続くすべてのテキストを削除します。

5. 上記を完了したら、**:** の後の削除したテキストを、前のタスクで保存した値に置き換えます (注: 値は引用符で囲む必要があります)。

   a. **azureOpenAIKey** は、前のタスクの**API キー**です。

   b. **azureOpenAIEndpoint** は、前のタスクの**エンドポイント**です。
   
   c. **"gpt-4"** の**azureOpenAIDeploymentName** 型
   
**注** すべてのテキストが引用符で囲まれていることを確認してください。
   
6. **[ファイル]** >**[すべて保存]**
    
7. キーボードで**Ctrl+Shift+d** を押すと、左上にドロップダウンが表示され、そこに緑色の再生ボタンと、[デバッグ] > [ドロップダウンを選択] という文字が表示されるので、**[Microsoft 365 エージェント プレイグラウンドでデバッグする]** を選択して**F5** キーを押します。
8. カスタム エンジン エージェントは、選択したデバッグ ツール内で実行され、ブラウザー上に開きます。 
9. アプリの VS Code ウィンドウに戻ります。 **[デバッグ]** ボタンのドロップダウンを選択し、**[Teams (Edge) で デバッグ]** を選択して、**[F5]** または [gren] 再生ボタンを押します。
10. Edge ブラウザで新しいウィンドウが開きます。 サインインするようダイアログが表示される場合があります。 指定されたログイン情報を使用してサインインします。 正常にサインインしたら ウィンドウを閉じます。
11. 新しく作成したアプリのタイトルが表示されたウィンドウが表示されます。 **[追加]** >**[開く]** を選択します。
12. おめでとうございます! RAG データ ファイルに関する質問をエージェントに問い合わせることができるようになりました。
13. **注:** 自分の環境でこのラボを完了する学習者の場合、このエージェントは、自分のサブスクリプションを使用して教育目的で作成されたため、ユーザーはこのラボの終了後にエージェントの削除を行う必要があります。 Microsoft Teams のカスタム エージェントを削除するには、次の方法があります。
- 削除するエージェントを選択し、**"その他のオプション" アイコン ([...])** を選択し、**[削除]** を選択します。
- スレッドの省略記号を選択し、**[アプリの管理]** を選択して、チャットからエージェントを削除します。
- エージェントの作成エクスペリエンスから、**省略記号 ([...])** を選択し、**[削除]** を選択します。- エージェントの作成エクスペリエンスから、**省略記号 ([...])** を選択し、**[削除]** を選択します。

**ラボは以上**

